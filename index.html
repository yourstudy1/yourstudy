<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Study</title>

<style>
body{
margin:0;
font-family:Segoe UI;
background:#111;
color:white;
}

/* DASHBOARD */
#dashboard{
padding:20px;
}

.card{
background:rgba(255,255,255,0.08);
padding:20px;
border-radius:15px;
margin-bottom:15px;
}

/* TAB MODE */
#tabMode{
display:none;
position:fixed;
top:0;
left:0;
width:100vw;
height:100vh;
background-size:cover;
background-position:center;
z-index:9999;
text-align:center;
}

.overlay{
background:rgba(0,0,0,0.75);
height:100%;
padding-top:40px;
}

#time{font-size:90px;font-weight:bold;}
#date{font-size:28px;}
#temp{font-size:24px;}
#subject{font-size:60px;margin-top:40px;font-weight:bold;}
#warningTimer{font-size:35px;color:orange;}
#studyTimer{font-size:40px;}
#nextSubject{font-size:24px;margin-top:15px;}
#customBox{font-size:24px;margin-top:10px;}

.red{color:red;}

button{
padding:8px 15px;
border:none;
border-radius:8px;
cursor:pointer;
background:#333;
color:white;
margin:5px;
}

#exitBtn{
position:absolute;
bottom:20px;
right:30px;
font-size:14px;
background:rgba(0,0,0,0.6);
}
</style>
</head>

<body>

<!-- DASHBOARD -->
<div id="dashboard">
<h2>Study Dashboard</h2>
<button onclick="enterTab()">Tab Mode</button>
<a href="admin.html"><button>Admin</button></a>
</div>

<!-- TAB MODE -->
<div id="tabMode">
<div class="overlay">

<div id="time"></div>
<div id="date"></div>
<div id="temp"></div>
<div id="customBox"></div>

<div id="subject"></div>
<div id="warningTimer"></div>
<div id="studyTimer"></div>
<div id="nextSubject"></div>

<button onclick="cancelStudy()">Cancel</button>
<button id="exitBtn" onclick="exitTab()">Exit</button>

</div>
</div>

<script>
const scriptURL = "https://script.google.com/macros/s/AKfycbxq49CFhIWiKHxh69xPBczmBuiMcjw5YIoYuEq6lwZYybsAZWuG2Q9q8guseFWTa2Wd0A/exec";
/* ===========================
   WALLPAPER AUTO CHANGE
=========================== */
function changeWallpaper(){
const url="https://picsum.photos/1920/1080?random="+Date.now();
document.getElementById("tabMode").style.backgroundImage="url('"+url+"')";
}
changeWallpaper();
setInterval(changeWallpaper,900000);

/* ===========================
   CLOCK + DATE
=========================== */
setInterval(()=>{
let now=new Date();
document.getElementById("time").innerText=now.toLocaleTimeString();
document.getElementById("date").innerText=now.toDateString();
},1000);

/* ===========================
   TEMPERATURE
=========================== */
fetch("https://api.open-meteo.com/v1/forecast?latitude=23.5&longitude=87.3&current_weather=true")
.then(res=>res.json())
.then(data=>{
document.getElementById("temp").innerText=
"Temperature: "+data.current_weather.temperature+"Â°C";
});

/* ===========================
   COLOR CHANGE FROM ADMIN
=========================== */
setInterval(()=>{
let color=localStorage.getItem("textColor")||"white";
document.getElementById("time").style.color=color;
},1000);

/* ===========================
   CUSTOM NOTIFICATION
=========================== */
setInterval(()=>{
let data=JSON.parse(localStorage.getItem("customNotification"));
if(data && Date.now()<data.expire){
document.getElementById("customBox").innerText=data.message;
}else{
document.getElementById("customBox").innerText="";
}
},1000);

/* ===========================
   MODE SYSTEM
=========================== */
let systemMode="normal";
let routine=[];
let activeIndex=-1;
let warningInterval;
let studyInterval;
let studySeconds=0;

try{
routine=JSON.parse(localStorage.getItem("routine"))||[];
}catch(e){}

setInterval(checkSchedule,1000);

function checkSchedule(){

systemMode=localStorage.getItem("systemMode")||"normal";

if(systemMode==="sleep"){
clearAll();
document.getElementById("subject").innerText="SLEEP MODE";
return;
}

if(systemMode==="office"){
clearAll();
document.getElementById("subject").innerText="OFFICE TIME";
return;
}

let now=new Date();

routine.forEach((item,index)=>{

let start=new Date();
let [h,m]=item.time.split(":");
start.setHours(h);
start.setMinutes(m);
start.setSeconds(0);

let diff=Math.floor((start-now)/60000);

/* WARNING (10 MIN) */
if(diff===10 && activeIndex!==index && systemMode!=="mock"){
startWarning(index,item);
}

});
}

/* ===========================
   WARNING COUNTDOWN
=========================== */
function startWarning(index,item){

activeIndex=index;
let seconds=600;

clearInterval(warningInterval);

warningInterval=setInterval(()=>{

seconds--;

let m=Math.floor(seconds/60);
let s=seconds%60;

document.getElementById("subject").innerText="Upcoming: "+item.subject;
document.getElementById("warningTimer").innerText=
"Warning: "+m+":"+String(s).padStart(2,"0");

if(seconds<=0){
clearInterval(warningInterval);
startStudy(item);
}

},1000);

}

/* ===========================
   STUDY COUNTDOWN
=========================== */
function startStudy(item){

studySeconds=item.duration*60;

clearInterval(studyInterval);

studyInterval=setInterval(()=>{

studySeconds--;

let m=Math.floor(studySeconds/60);
let s=studySeconds%60;

document.getElementById("warningTimer").innerText="";
document.getElementById("subject").innerText=item.subject;
document.getElementById("studyTimer").innerText=
"Study: "+m+":"+String(s).padStart(2,"0");

if(studySeconds<=0){
cancelStudy();
}

},1000);

}

/* ===========================
   CANCEL
=========================== */
function cancelStudy(){
clearAll();
document.getElementById("subject").innerText="CANCELLED";
}

/* ===========================
   CLEAR
=========================== */
function clearAll(){
clearInterval(warningInterval);
clearInterval(studyInterval);
document.getElementById("warningTimer").innerText="";
document.getElementById("studyTimer").innerText="";
}

/* ===========================
   NEXT SUBJECT
=========================== */
setInterval(()=>{
if(routine.length>0){
document.getElementById("nextSubject").innerText=
"Next: "+routine[0].subject+" at "+routine[0].time;
}
},5000);

/* ===========================
   MODE SWITCH
=========================== */
function enterTab(){
document.getElementById("dashboard").style.display="none";
document.getElementById("tabMode").style.display="block";
}
function exitTab(){
document.getElementById("dashboard").style.display="block";
document.getElementById("tabMode").style.display="none";
}

</script>
</body>
</html>
