<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Study OS</title>

<style>
body{
margin:0;
font-family:Arial;
background:#111;
color:white;
background-size:cover;
background-position:center;
transition:0.5s;
}

button{
padding:6px 12px;
margin:5px;
border:none;
border-radius:5px;
cursor:pointer;
}

#tabView{
display:none;
height:100vh;
text-align:center;
position:relative;
}

#customBox{
font-size:28px;
margin-bottom:10px;
}

.red{ color:red; }
</style>
</head>

<body>

<h2>
Dashboard
<button onclick="enableTab()">Tab Mode</button>
<a href="admin.html"><button>Admin</button></a>
</h2>

<!-- TAB MODE -->
<div id="tabView">

<div style="margin-top:12vh;">

<div id="clock" style="font-size:70px;"></div>

<div id="customBox"></div>

<div id="subject" style="font-size:40px;"></div>
<div id="remaining" style="font-size:32px;"></div>

<div id="warningBox" style="display:none; margin-top:20px;"></div>

</div>

<button onclick="exitTab()" 
style="position:absolute; bottom:10px; right:15px; font-size:12px;">
EXIT
</button>

</div>

<script>

const scriptURL="https://script.google.com/macros/s/AKfycbzMo6vhjfnZcsi2Q7IUlYSIHaY4wVcpL8fv8iSIxHRlgrQ4ufpFZ6N4dVLiorU-OvFp9Q/exec";

/* WALLPAPER */
function changeWallpaper(){
const url="https://picsum.photos/1600/900?random="+new Date().getTime();
document.body.style.backgroundImage="url('"+url+"')";
}
changeWallpaper();
setInterval(changeWallpaper,900000);

/* TAB MODE */
function enableTab(){
document.getElementById("tabView").style.display="block";
}
function exitTab(){
document.getElementById("tabView").style.display="none";
}

/* CLOCK */
setInterval(()=>{
const now=new Date();
document.getElementById("clock").innerText=now.toLocaleTimeString();
},1000);

/* LOAD ROUTINE */
let routine=JSON.parse(localStorage.getItem("routine"))||[];
let color=localStorage.getItem("textColor")||"white";
document.getElementById("subject").style.color=color;

let currentIndex=-1;
let timer;
let remainingSeconds=0;
let warning10=false;

setInterval(checkRoutine,1000);

function checkRoutine(){

const now=new Date();
const currentTime=
String(now.getHours()).padStart(2,"0")+":"+
String(now.getMinutes()).padStart(2,"0");

routine.forEach((item,index)=>{
if(item.time===currentTime && currentIndex!==index){
startSubject(index,item.subject,item.duration);
}
});
}

function startSubject(index,subject,duration){

currentIndex=index;
warning10=false;

document.getElementById("subject").innerText=subject;
remainingSeconds=duration*60;

clearInterval(timer);

timer=setInterval(()=>{

remainingSeconds--;

let m=Math.floor(remainingSeconds/60);
let s=remainingSeconds%60;

document.getElementById("remaining").innerText=
m+":"+String(s).padStart(2,"0");

if(remainingSeconds===600 && !warning10){
warning10=true;
showWarning(subject,"10 Minutes Left");
}

if(remainingSeconds<=0){
clearInterval(timer);
showWarning(subject,"Time Over");
}

},1000);
}

function showWarning(subject,msg){

document.getElementById("warningBox").style.display="block";
document.getElementById("warningBox").innerHTML=
"âš  "+msg+"<br><br>"+
"<button onclick='extraTime()'>3 Attempt</button>"+
"<button onclick='finalTime()'>Final</button>"+
"<button onclick='cancelStudy()'>Cancel</button>";

fetch(scriptURL,{
method:"POST",
body:new URLSearchParams({
type:"warning",
subject:subject,
message:msg
})
});
}

function extraTime(){
remainingSeconds=300;
document.getElementById("warningBox").style.display="none";
}

function finalTime(){
remainingSeconds=60;
document.getElementById("warningBox").style.display="none";
}

function cancelStudy(){
clearInterval(timer);
document.getElementById("subject").innerText="CANCELLED";
document.getElementById("remaining").classList.add("red");
document.getElementById("warningBox").style.display="none";
}

/* CUSTOM NOTIFICATION AUTO DELETE */
setInterval(()=>{
let data=JSON.parse(localStorage.getItem("customNotification"));

if(data){
if(Date.now()<data.expire){
document.getElementById("customBox").innerText=data.message;
}else{
localStorage.removeItem("customNotification");
document.getElementById("customBox").innerText="";
}
}
},1000);

</script>

</body>
</html>
