<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Study Ultimate</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
body{
margin:0;
font-family:Arial;
background:#111;
color:white;
transition:0.4s;
}

.card{
background:rgba(255,255,255,0.08);
backdrop-filter:blur(10px);
padding:20px;
border-radius:15px;
margin:15px;
}

button{
padding:8px 15px;
border:none;
border-radius:8px;
cursor:pointer;
background:#444;
color:white;
}

#tabMode{
display:none;
height:100vh;
text-align:center;
background-size:cover;
background-position:center;
}

#clockBig{font-size:70px;margin-top:40px;}
#subjectBig{font-size:45px;margin-top:15vh;}
#remainBig{font-size:30px;margin-top:10px;}
.red{color:red;}
.orange{color:orange;}
</style>
</head>
<body>

<div id="dashboard">

<h2>Smart Study Dashboard</h2>

<button onclick="enterTab()">Tab Mode</button>
<a href="admin.html"><button>Admin</button></a>

<div class="card">
<div id="liveTime"></div>
<div id="liveDate"></div>
</div>

<div class="card">
<canvas id="chart"></canvas>
</div>

</div>

<div id="tabMode">
<div id="clockBig"></div>
<div id="subjectBig"></div>
<div id="remainBig"></div>
<div id="warningBox"></div>
<button onclick="exitTab()">EXIT</button>
</div>

<script>

const scriptURL="https://script.google.com/macros/s/AKfycbwNOOoUixPcRWeMjIv9C2TgqEREVtoFhlOwqnkn2QJt2OZluQyvju5SaBXNhnN_KHsQTQ/exec";

/* CLOCK */
setInterval(()=>{
let now=new Date();
document.getElementById("liveTime").innerText=now.toLocaleTimeString();
document.getElementById("liveDate").innerText=now.toDateString();
document.getElementById("clockBig").innerText=now.toLocaleTimeString();
},1000);

/* SHEET GRAPH */
fetch(scriptURL+"?action=sheet")
.then(res=>res.json())
.then(data=>{

let labels=data.map(r=>r[0]);
let values=data.map(r=>r[1]);

new Chart(document.getElementById("chart"),{
type:"bar",
data:{
labels:labels,
datasets:[{
label:"Study Hours",
data:values,
backgroundColor:"rgba(0,123,255,0.6)"
}]
}
});

});

/* ROUTINE */
let routine=[];
try{routine=JSON.parse(localStorage.getItem("routine"))||[];}catch(e){}

let activeIndex=-1;
let warningTimer, studyTimer;

setInterval(checkSchedule,1000);

function checkSchedule(){
let now=new Date();
routine.forEach((item,index)=>{

let start=new Date();
let [h,m]=item.time.split(":");
start.setHours(h);
start.setMinutes(m);
start.setSeconds(0);

let diff=Math.floor((start-now)/60000);

if(diff===10 && activeIndex!==index){
preWarning(index,item);
}

});
}

function preWarning(index,item){

activeIndex=index;

document.getElementById("subjectBig").innerText="Upcoming: "+item.subject;
document.getElementById("subjectBig").className="orange";

document.getElementById("warningBox").innerHTML=
"<button onclick='startNow()'>Start</button>"+
"<button onclick='cancelNow()'>Cancel</button>"+
"<button onclick='sameSubject()'>Same</button>";

fetch(scriptURL,{
method:"POST",
body:new URLSearchParams({
type:"warning",
subject:item.subject,
message:"Starting in 10 Minutes"
})
});

}

function startNow(){
startStudy(routine[activeIndex]);
}

function sameSubject(){
startStudy(routine[activeIndex]);
}

function cancelNow(){
document.getElementById("subjectBig").innerText="CANCELLED";
document.getElementById("subjectBig").className="red";
document.getElementById("remainBig").innerText="";
}

function startStudy(item){

setWallpaper(item.subject);

let seconds=item.duration*60;

studyTimer=setInterval(()=>{

seconds--;

let m=Math.floor(seconds/60);
let s=seconds%60;

document.getElementById("subjectBig").innerText=item.subject;
document.getElementById("remainBig").innerText=
m+":"+String(s).padStart(2,"0");

if(seconds<=0){
cancelNow();
}

},1000);

}

/* SUBJECT WALLPAPER */
function setWallpaper(subject){

let images={
Math:"https://picsum.photos/1600/900?math",
English:"https://picsum.photos/1600/900?english",
GS:"https://picsum.photos/1600/900?history",
Reasoning:"https://picsum.photos/1600/900?logic"
};

document.getElementById("tabMode").style.backgroundImage=
"url('"+(images[subject]||"https://picsum.photos/1600/900") +"')";
}

function enterTab(){
document.getElementById("dashboard").style.display="none";
document.getElementById("tabMode").style.display="block";
}

function exitTab(){
document.getElementById("dashboard").style.display="block";
document.getElementById("tabMode").style.display="none";
}

</script>
</body>
</html>
