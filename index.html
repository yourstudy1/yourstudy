<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Study FINAL</title>

<style>
body{
margin:0;
font-family:Arial;
background:#111;
color:white;
}

.overlay{
background:rgba(0,0,0,0.75);
min-height:100vh;
padding:20px;
}

/* Dashboard */
.card{
background:rgba(255,255,255,0.08);
padding:20px;
border-radius:15px;
margin-bottom:15px;
backdrop-filter:blur(10px);
}

button{
padding:8px 15px;
border:none;
border-radius:8px;
cursor:pointer;
background:#333;
color:white;
}

.big{font-size:24px;}
.red{color:red;}
.orange{color:orange;}

/* TAB MODE */
#tabMode{
display:none;
text-align:center;
height:100vh;
background-size:cover;
background-position:center;
position:relative;
}

#clockBig{font-size:65px;margin-top:40px;}
#subjectBig{font-size:45px;margin-top:18vh;}
#remainBig{font-size:30px;}
#warningBox{margin-top:20px;}

#exitBtn{
position:absolute;
bottom:20px;
right:20px;
font-size:12px;
background:rgba(0,0,0,0.6);
}
</style>
</head>

<body>

<div class="overlay">

<div id="dashboard">

<h2>Smart Study</h2>

<div class="card">
<div id="time" class="big"></div>
<div id="date"></div>
</div>

<div class="card">
<div id="temperature"></div>
</div>

<div class="card">
<div id="customBox"></div>
</div>

<button onclick="enterTab()">Tab Mode</button>
<a href="admin.html"><button>Admin</button></a>

</div>

<div id="tabMode">
<div id="clockBig"></div>
<div id="subjectBig"></div>
<div id="remainBig"></div>
<div id="warningBox"></div>
<button id="exitBtn" onclick="exitTab()">EXIT</button>
</div>

</div>

<script>

const scriptURL="https://script.google.com/macros/s/AKfycbwNOOoUixPcRWeMjIv9C2TgqEREVtoFhlOwqnkn2QJt2OZluQyvju5SaBXNhnN_KHsQTQ/exec";

/* ===== CLOCK + DATE ===== */
setInterval(()=>{
let now=new Date();
document.getElementById("time").innerText=now.toLocaleTimeString();
document.getElementById("date").innerText=now.toDateString();
document.getElementById("clockBig").innerText=now.toLocaleTimeString();
},1000);

/* ===== TEMPERATURE (NO API KEY) ===== */
fetch("https://api.open-meteo.com/v1/forecast?latitude=23.5&longitude=87.3&current_weather=true")
.then(res=>res.json())
.then(data=>{
document.getElementById("temperature").innerText=
"Temperature: "+data.current_weather.temperature+"Â°C";
}).catch(()=>{});

/* ===== CUSTOM NOTIFICATION (15 MIN) ===== */
setInterval(()=>{
let data=JSON.parse(localStorage.getItem("customNotification"));
if(data){
if(Date.now()<data.expire){
document.getElementById("customBox").innerText=data.message;
}else{
localStorage.removeItem("customNotification");
document.getElementById("customBox").innerText="";
}
}
},1000);

/* ===== COLOR CHANGE REFLECT ===== */
function applyColor(){
let color=localStorage.getItem("textColor")||"white";
document.getElementById("subjectBig").style.color=color;
}
setInterval(applyColor,1000);

/* ===== AUTO WALLPAPER 15 MIN ===== */
function changeWallpaper(){
const url="https://source.unsplash.com/1600x900/?study,night&"+Date.now();
document.getElementById("tabMode").style.backgroundImage="url('"+url+"')";
}
changeWallpaper();
setInterval(changeWallpaper,900000);

/* ===== ROUTINE ===== */
let routine=[];
try{routine=JSON.parse(localStorage.getItem("routine"))||[];}catch(e){}

let activeIndex=-1;
let studyTimer;

setInterval(checkSchedule,1000);

function checkSchedule(){
let now=new Date();

routine.forEach((item,index)=>{

let start=new Date();
let [h,m]=item.time.split(":");
start.setHours(h);
start.setMinutes(m);
start.setSeconds(0);

let diff=Math.floor((start-now)/60000);

if(diff===10 && activeIndex!==index){
preWarning(index,item);
}

});
}

/* ===== PRE WARNING ===== */
function preWarning(index,item){
activeIndex=index;

document.getElementById("subjectBig").innerText="Upcoming: "+item.subject;
document.getElementById("subjectBig").className="orange";

document.getElementById("warningBox").innerHTML=
"<button onclick='startNow()'>Start</button>"+
"<button onclick='cancelNow()'>Cancel</button>"+
"<button onclick='sameSubject()'>Same</button>";

fetch(scriptURL,{
method:"POST",
body:new URLSearchParams({
type:"warning",
subject:item.subject,
message:"Starting in 10 Minutes"
})
});
}

/* ===== BUTTON ACTION ===== */
function startNow(){
startStudy(routine[activeIndex]);
}

function sameSubject(){
startStudy(routine[activeIndex]);
}

function cancelNow(){
clearInterval(studyTimer);
document.getElementById("subjectBig").innerText="CANCELLED";
document.getElementById("subjectBig").className="red";
document.getElementById("remainBig").innerText="";
}

/* ===== STUDY TIMER ===== */
function startStudy(item){
let seconds=item.duration*60;

studyTimer=setInterval(()=>{
seconds--;

let m=Math.floor(seconds/60);
let s=seconds%60;

document.getElementById("subjectBig").innerText=item.subject;
document.getElementById("subjectBig").className="";
document.getElementById("remainBig").innerText=
m+":"+String(s).padStart(2,"0");

if(seconds<=0){
cancelNow();
}

},1000);
}

/* ===== TAB MODE ===== */
function enterTab(){
document.getElementById("dashboard").style.display="none";
document.getElementById("tabMode").style.display="block";
}

function exitTab(){
document.getElementById("dashboard").style.display="block";
document.getElementById("tabMode").style.display="none";
}

</script>
</body>
</html>
